name: Preview Cleanup

on:
  pull_request:
    types: [closed]
    branches:
      - dev  # Only cleanup previews for PRs targeting dev

jobs:
  cleanup-preview:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    environment: Staging
    permissions:
      id-token: write
      contents: read
      pull-requests: write
      deployments: write

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Azure Login
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Add Container App Extension
        run: az extension add --name containerapp --upgrade

      - name: Deactivate Revision and Remove Label
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          LABEL="pr-${PR_NUMBER}"
          
          echo "Cleaning up revision with label: $LABEL"
          
          # Remove the label from the revision (this effectively makes the URL 404)
          # We need to find the revision associated with this label first
          
          # List revisions with this label (Azure CLI filtering might be needed)
          # Logic: Get the revision name that has this label
          
          REV_NAME=$(az containerapp revision label list \
            --name ${{ secrets.CONTAINER_APP_NAME }} \
            --resource-group ${{ secrets.RESOURCE_GROUP }} \
            --query "[?label=='$LABEL'].revision" -o tsv)
            
          if [ -z "$REV_NAME" ]; then
            echo "No active revision found for label $LABEL. It might have already been deleted."
            exit 0
          fi
          
          echo "Found revision: $REV_NAME"
          
          # Remove the label
          az containerapp revision label remove \
            --resource-group ${{ secrets.RESOURCE_GROUP }} \
            --name ${{ secrets.CONTAINER_APP_NAME }} \
            --label $LABEL
            
          # Deactivate the revision explicitly
          az containerapp revision deactivate \
            --resource-group ${{ secrets.RESOURCE_GROUP }} \
            --name ${{ secrets.CONTAINER_APP_NAME }} \
            --revision $REV_NAME
            
          echo "Cleanup complete."

      - name: Update GitHub Deployment Status (Inactive)
        uses: bobheadxi/deployments@648679e8e4915b27893bd7dbc35cb504dc915bc8 # v1
        if: always()
        with:
          step: deactivate-env
          token: ${{ secrets.GITHUB_TOKEN }}
          env: preview-${{ github.event.pull_request.number }}
          desc: Preview environment cleaned up.

      - name: Post Sticky Comment
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2
        with:
          header: preview-environment
          message: |
            ### üóëÔ∏è Preview Environment Destroyed
            
            The preview environment for PR #${{ github.event.pull_request.number }} has been cleaned up.

