name: Preview Reaper

on:
  schedule:
    # Run at midnight UTC every day
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  reap-zombies:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    environment: Staging
    permissions:
      id-token: write
      contents: read
      pull-requests: read

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6

      - name: Azure Login
        uses: azure/login@a457da9ea143d694b1b9c7c869ebb04ebe844ef5 # v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Add Container App Extension
        run: az extension add --name containerapp --upgrade

      - name: Identify and Cleanup Zombies
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching all active revisions with 'pr-*' labels..."
          
          # Get list of labels: revisionName, labelName
          # Output format: revName labelName
          LABELS=$(az containerapp revision label list \
            --name ${{ secrets.CONTAINER_APP_NAME }} \
            --resource-group ${{ secrets.RESOURCE_GROUP }} \
            --query "[?starts_with(label, 'pr-')].[revisionName, label]" -o tsv)
            
          if [ -z "$LABELS" ]; then
            echo "No active preview revisions found."
            exit 0
          fi
          
          # Iterate through each labeled revision
          echo "$LABELS" | while read -r REV_NAME LABEL; do
            echo "Checking $REV_NAME with label $LABEL..."
            
            # Extract PR number from label (pr-123 -> 123)
            PR_NUMBER=$(echo $LABEL | sed 's/pr-//')
            
            # Check GitHub PR status
            # We use 'gh' cli which is pre-installed on runners
            PR_STATE=$(gh pr view $PR_NUMBER --json state --jq .state || echo "NOT_FOUND")
            
            echo "PR #$PR_NUMBER state: $PR_STATE"
            
            if [ "$PR_STATE" == "CLOSED" ] || [ "$PR_STATE" == "MERGED" ] || [ "$PR_STATE" == "NOT_FOUND" ]; then
              echo "üßü ZOMBIE DETECTED! PR is closed but revision is active. Destroying..."
              
              # Remove label
              az containerapp revision label remove \
                --resource-group ${{ secrets.RESOURCE_GROUP }} \
                --name ${{ secrets.CONTAINER_APP_NAME }} \
                --label $LABEL
                
              # Deactivate revision
              az containerapp revision deactivate \
                --resource-group ${{ secrets.RESOURCE_GROUP }} \
                --name ${{ secrets.CONTAINER_APP_NAME }} \
                --revision $REV_NAME
                
              echo "‚úÖ Zombie neutralized."
            else
              echo "üëç PR is still open. Keeping revision."
            fi
          done

