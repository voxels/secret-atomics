(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&n(c)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function n(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();const W="modulepreload",V=function(g){return"/dolores/"+g},A={},U=function(e,t,n){let i=Promise.resolve();if(t&&t.length>0){let h=function(m){return Promise.all(m.map(x=>Promise.resolve(x).then(w=>({status:"fulfilled",value:w}),w=>({status:"rejected",reason:w}))))};var c=h;document.getElementsByTagName("link");const a=document.querySelector("meta[property=csp-nonce]"),d=a?.nonce||a?.getAttribute("nonce");i=h(t.map(m=>{if(m=V(m),m in A)return;A[m]=!0;const x=m.endsWith(".css"),w=x?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${m}"]${w}`))return;const b=document.createElement("link");if(b.rel=x?"stylesheet":W,x||(b.as="script"),b.crossOrigin="",b.href=m,d&&b.setAttribute("nonce",d),document.head.appendChild(b),x)return new Promise((v,k)=>{b.addEventListener("load",v),b.addEventListener("error",()=>k(new Error(`Unable to preload CSS for ${m}`)))})}))}function o(a){const d=new Event("vite:preloadError",{cancelable:!0});if(d.payload=a,window.dispatchEvent(d),!d.defaultPrevented)throw a}return i.then(a=>{for(const d of a||[])d.status==="rejected"&&o(d.reason);return e().catch(o)})};function j(){throw new Error("Buffer is not included.")}j.isBuffer=function(){return!1};var K=50;const Y=Object.freeze(Object.defineProperty({__proto__:null,Buffer:j,INSPECT_MAX_BYTES:K,SlowBuffer:j},Symbol.toStringTag,{value:"Module"})),J={};function O(){}function X(){for(var g=arguments.length,e=new Array(g),t=0;t<g;t++)e[t]=arguments[t];var n=e[0];e.shift(),setTimeout(function(){typeof n=="function"&&n.apply(null,e)},0)}function Z(g){throw new Error("No such module. (Possibly not yet loaded)")}var ee={},$="browser",te=1,ne=!0,oe={},ie=[],D="/";function se(){return D}function re(g){D=J.resolve(g,D)}const ae=Object.freeze(Object.defineProperty({__proto__:null,arch:$,argv:ie,binding:Z,browser:ne,chdir:re,cwd:se,dlopen:O,env:oe,execPath:$,exit:O,features:ee,kill:O,memoryUsage:O,nextTick:X,pid:te,platform:$,title:$,umask:O,uptime:O,uvCounters:O},Symbol.toStringTag,{value:"Module"}));globalThis.Buffer=j||void 0||Y;globalThis.process=ae;class ce{products=new Map;constructor(e=[]){e.forEach(t=>this.products.set(t.id,t))}getProducts(){return Array.from(this.products.values())}getProduct(e){return this.products.get(e)}purchase(e){const t=this.products.get(e);return t?t.sold_out||t.stock<=0?{success:!1,reason:"Sold out"}:(t.stock-=1,t.stock===0&&(t.sold_out=!0),{success:!0}):{success:!1,reason:"Product not found"}}updateStock(e,t){const n=this.products.get(e);n&&(n.stock=t,n.sold_out=t<=0)}}var B={exports:{}},z;function le(){if(z)return B.exports;z=1;var g=typeof Reflect=="object"?Reflect:null,e=g&&typeof g.apply=="function"?g.apply:function(s,l,p){return Function.prototype.apply.call(s,l,p)},t;g&&typeof g.ownKeys=="function"?t=g.ownKeys:Object.getOwnPropertySymbols?t=function(s){return Object.getOwnPropertyNames(s).concat(Object.getOwnPropertySymbols(s))}:t=function(s){return Object.getOwnPropertyNames(s)};function n(r){console&&console.warn&&console.warn(r)}var i=Number.isNaN||function(s){return s!==s};function o(){o.init.call(this)}B.exports=o,B.exports.once=S,o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var c=10;function a(r){if(typeof r!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r)}Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:function(){return c},set:function(r){if(typeof r!="number"||r<0||i(r))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+r+".");c=r}}),o.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(s){if(typeof s!="number"||s<0||i(s))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+s+".");return this._maxListeners=s,this};function d(r){return r._maxListeners===void 0?o.defaultMaxListeners:r._maxListeners}o.prototype.getMaxListeners=function(){return d(this)},o.prototype.emit=function(s){for(var l=[],p=1;p<arguments.length;p++)l.push(arguments[p]);var u=s==="error",y=this._events;if(y!==void 0)u=u&&y.error===void 0;else if(!u)return!1;if(u){var f;if(l.length>0&&(f=l[0]),f instanceof Error)throw f;var E=new Error("Unhandled error."+(f?" ("+f.message+")":""));throw E.context=f,E}var _=y[s];if(_===void 0)return!1;if(typeof _=="function")e(_,this,l);else for(var C=_.length,T=v(_,C),p=0;p<C;++p)e(T[p],this,l);return!0};function h(r,s,l,p){var u,y,f;if(a(l),y=r._events,y===void 0?(y=r._events=Object.create(null),r._eventsCount=0):(y.newListener!==void 0&&(r.emit("newListener",s,l.listener?l.listener:l),y=r._events),f=y[s]),f===void 0)f=y[s]=l,++r._eventsCount;else if(typeof f=="function"?f=y[s]=p?[l,f]:[f,l]:p?f.unshift(l):f.push(l),u=d(r),u>0&&f.length>u&&!f.warned){f.warned=!0;var E=new Error("Possible EventEmitter memory leak detected. "+f.length+" "+String(s)+" listeners added. Use emitter.setMaxListeners() to increase limit");E.name="MaxListenersExceededWarning",E.emitter=r,E.type=s,E.count=f.length,n(E)}return r}o.prototype.addListener=function(s,l){return h(this,s,l,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(s,l){return h(this,s,l,!0)};function m(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function x(r,s,l){var p={fired:!1,wrapFn:void 0,target:r,type:s,listener:l},u=m.bind(p);return u.listener=l,p.wrapFn=u,u}o.prototype.once=function(s,l){return a(l),this.on(s,x(this,s,l)),this},o.prototype.prependOnceListener=function(s,l){return a(l),this.prependListener(s,x(this,s,l)),this},o.prototype.removeListener=function(s,l){var p,u,y,f,E;if(a(l),u=this._events,u===void 0)return this;if(p=u[s],p===void 0)return this;if(p===l||p.listener===l)--this._eventsCount===0?this._events=Object.create(null):(delete u[s],u.removeListener&&this.emit("removeListener",s,p.listener||l));else if(typeof p!="function"){for(y=-1,f=p.length-1;f>=0;f--)if(p[f]===l||p[f].listener===l){E=p[f].listener,y=f;break}if(y<0)return this;y===0?p.shift():k(p,y),p.length===1&&(u[s]=p[0]),u.removeListener!==void 0&&this.emit("removeListener",s,E||l)}return this},o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=function(s){var l,p,u;if(p=this._events,p===void 0)return this;if(p.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):p[s]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete p[s]),this;if(arguments.length===0){var y=Object.keys(p),f;for(u=0;u<y.length;++u)f=y[u],f!=="removeListener"&&this.removeAllListeners(f);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(l=p[s],typeof l=="function")this.removeListener(s,l);else if(l!==void 0)for(u=l.length-1;u>=0;u--)this.removeListener(s,l[u]);return this};function w(r,s,l){var p=r._events;if(p===void 0)return[];var u=p[s];return u===void 0?[]:typeof u=="function"?l?[u.listener||u]:[u]:l?I(u):v(u,u.length)}o.prototype.listeners=function(s){return w(this,s,!0)},o.prototype.rawListeners=function(s){return w(this,s,!1)},o.listenerCount=function(r,s){return typeof r.listenerCount=="function"?r.listenerCount(s):b.call(r,s)},o.prototype.listenerCount=b;function b(r){var s=this._events;if(s!==void 0){var l=s[r];if(typeof l=="function")return 1;if(l!==void 0)return l.length}return 0}o.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]};function v(r,s){for(var l=new Array(s),p=0;p<s;++p)l[p]=r[p];return l}function k(r,s){for(;s+1<r.length;s++)r[s]=r[s+1];r.pop()}function I(r){for(var s=new Array(r.length),l=0;l<s.length;++l)s[l]=r[l].listener||r[l];return s}function S(r,s){return new Promise(function(l,p){function u(f){r.removeListener(s,y),p(f)}function y(){typeof r.removeListener=="function"&&r.removeListener("error",u),l([].slice.call(arguments))}L(r,s,y,{once:!0}),s!=="error"&&P(r,u,{once:!0})})}function P(r,s,l){typeof r.on=="function"&&L(r,"error",s,l)}function L(r,s,l,p){if(typeof r.on=="function")p.once?r.once(s,l):r.on(s,l);else if(typeof r.addEventListener=="function")r.addEventListener(s,function u(y){p.once&&r.removeEventListener(s,u),l(y)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof r)}return B.exports}var de=le();class ue{emitter;channelHandlers=new Map;broadcastChannel;constructor(){this.emitter=new de.EventEmitter,this.broadcastChannel=new BroadcastChannel("dolores_realtime"),this.broadcastChannel.onmessage=e=>{const{channel:t,data:n}=e.data;console.log(`[RealtimeMock] Received cross-tab event on ${t}`,n),this.emitter.emit(t,n)}}subscribe(e,t){this.channelHandlers.has(e)||this.channelHandlers.set(e,new Set),this.channelHandlers.get(e).add(t),this.emitter.on(e,t),console.log(`[RealtimeMock] Subscribed to ${e}`)}publish(e,t){this.broadcastChannel.postMessage({channel:e,data:t});const n=Math.floor(Math.random()*50);setTimeout(()=>{this.emitter.emit(e,t),console.log(`[RealtimeMock] Published to ${e} with ${n}ms latency`,t)},n)}unsubscribe(e,t){const n=this.channelHandlers.get(e);n&&(n.delete(t),this.emitter.off(e,t))}emit(e,t){return this.publish(e,t)}send(e,t){return this.publish(e,t)}on(e,t){return this.subscribe(e,t)}connect(){return console.log("[RealtimeMock] Connected (Simulated)"),this}}const pe=[{id:"gold_100",name:"100 Reddit Gold",price_gold:100,stock:999,sold_out:!1},{id:"gold_500",name:"500 Reddit Gold",price_gold:450,stock:100,sold_out:!1},{id:"custom_avatar_rare",name:"Ultra Rare Avatar",price_gold:500,stock:5,sold_out:!1}],he={Timers:{cooldownMs:5e3,respawnMs:3e3},Limits:{maxDailyPixels:100,maxStackSize:5}},fe={Animations:{placePixelDuration:300,overlayFadeIn:150,easing:"cubic-bezier(0.4, 0, 0.2, 1)"},Colors:{primary:"#FF4500",secondary:"#0079D3",error:"#FF0000",success:"#00BA7C",canvasBackground:"#FFFFFF"}},me={Onboarding:{welcomeTitle:"Welcome to Pixel Placer",welcomeBody:"Place pixels and create art together!"},Errors:{cooldown:"You are doing that too much. Take a break!",soldOut:"Sorry, we are all out of pixels."},Buttons:{place:"Place Pixel",buy:"Get More"}},ge={Gameplay:he,Visuals:fe,Copy:me};class ye{userId;subredditId;bucketId;reddit;redis;realtime;kv;media;ui;config;_state;economy;constructor(e={}){this.userId=e.userId||"t2_user123",this.subredditId=e.subredditId||"t5_sub456",this.bucketId=e.bucketId||(Math.random()>.5?"treatment":"control"),this.config=ge,this.economy=new ce(e.initialProducts||pe),this.reddit=this._mockReddit(),this.redis=this._mockRedis(),this.realtime=new ue,this.kv=this._mockKV(),this.media=this._mockMedia(),this._state=new Map,this.ui=this._mockUI()}getBucket(){return this.bucketId}useState(e){const t=JSON.stringify(e);return this._state.has(t)||this._state.set(t,e),[this._state.get(t),n=>{const i=this._state.get(t),o=typeof n=="function"?n(i):n;this._state.set(t,o)}]}_mockReddit(){return{getCurrentUser:async()=>({id:this.userId,name:"dummy_user"}),getSubredditById:async e=>({id:e,name:"test_sub"}),getCurrentSubreddit:async()=>({id:this.subredditId,name:"test_sub"}),getProducts:async()=>this.economy.getProducts(),pay:async e=>{const t=this.economy.getProduct(e.productId),n=this.economy.purchase(e.productId);return console.log(`[MockEconomy] Triggering Modal for ${t?.name||e.productId}`),n.success?{status:"success"}:{status:"failed",reason:n.reason}}}}_mockRedis(){const e=new Map,t=typeof process<"u"&&process.versions!=null&&process.versions.node!=null,n=".dolores_redis_dump.json",i="dolores_redis_dump";if(t)try{const c=require("fs");if(c.existsSync(n)){const a=JSON.parse(c.readFileSync(n,"utf-8"));Object.entries(a).forEach(([d,h])=>e.set(d,h)),console.log("[MockRedis] Loaded persistent state from disk.")}}catch(c){console.warn("[MockRedis] Failed to load persistent state:",c)}else if(typeof localStorage<"u")try{const c=localStorage.getItem(i);if(c){const a=JSON.parse(c);Object.entries(a).forEach(([d,h])=>e.set(d,h)),console.log("[MockRedis] Loaded persistent state from localStorage.")}}catch(c){console.warn("[MockRedis] Failed to load localStorage:",c)}const o=()=>{const c=Object.fromEntries(e),a=JSON.stringify(c,null,2);if(t)try{require("fs").writeFileSync(n,a)}catch(d){console.error("[MockRedis] Persistence failed:",d)}else typeof localStorage<"u"&&localStorage.setItem(i,a)};return{get:async c=>e.get(c),set:async(c,a)=>{e.set(c,a),o()},del:async c=>{e.delete(c),o()},hGet:async(c,a)=>(e.get(c)||{})[a],hSet:async(c,a,d)=>{const h=e.get(c)||{};h[a]=d,e.set(c,h),o()}}}_mockKV(){const e=new Map;return{get:async t=>e.get(t),put:async(t,n)=>{e.set(t,n)},delete:async t=>{e.delete(t)},list:async()=>Array.from(e.keys())}}_mockMedia(){return{upload:async e=>({id:`media_${Math.random().toString(36).substr(2,9)}`,url:e}),getMediaById:async e=>({id:e,url:`https://mock.reddit.com/${e}.jpg`})}}_mockUI(){return{showToast:e=>{console.log(`[MockUI] Toast: ${typeof e=="string"?e:e.text}`)},navigateTo:e=>{console.log(`[MockUI] Navigating to: ${e}`)},showForm:e=>(console.log(`[MockUI] Showing form: ${e}`),Promise.resolve({values:{}}))}}}class be{si;userId;startTime;totalActiveTime=0;lastVisibleStart;constructor(e,t="anon"){this.si=e,this.userId=t,this.startTime=Date.now(),this.lastVisibleStart=Date.now(),typeof document<"u"&&this.attach()}attach(){document.addEventListener("visibilitychange",()=>{if(document.hidden){const e=Date.now()-this.lastVisibleStart;this.totalActiveTime+=e,this.si.capture("session_visibility_hidden",this.userId,{active_segment_ms:e,total_active_ms:this.totalActiveTime})}else this.lastVisibleStart=Date.now(),this.si.capture("session_visibility_visible",this.userId,{})}),window.addEventListener("beforeunload",()=>{const e=Date.now()-this.lastVisibleStart;document.hidden||(this.totalActiveTime+=e),this.si.capture("session_end",this.userId,{total_duration_ms:Date.now()-this.startTime,total_active_ms:this.totalActiveTime})})}}class Q{events=[];capture(e,t,n={}){const i={event_type:e,user_id:t,timestamp:Date.now(),payload:n};return this.events.push(i),console.log(`[SignalIntegrity] Captured ${e} for ${t}`,n),i}detectRageClicks(e,t=3,n=1e3){return e.length<t?!1:e.filter(o=>Date.now()-o<n).length>=t}simulateThetaSketch(e){const n=new Set(e).size;return{estimate:n,lowerBound:Math.floor(n*.98),upperBound:Math.ceil(n*1.02)}}getEvents(){return[...this.events]}clear(){this.events=[]}}const xe=Object.freeze(Object.defineProperty({__proto__:null,SessionTracker:be,SignalIntegrity:Q},Symbol.toStringTag,{value:"Module"}));class F{container=null;signalIntegrity;mockContext;constructor(e,t){this.signalIntegrity=e,this.mockContext=t}mount(e=document.body){this.container=document.createElement("div"),this.container.id="dolores-debug-overlay",this.applyStyles(),e.appendChild(this.container),this.render(),setInterval(()=>this.render(),1e3)}applyStyles(){this.container&&Object.assign(this.container.style,{position:"fixed",top:"10px",right:"10px",width:"300px",backgroundColor:"rgba(0, 0, 0, 0.85)",color:"#00ff00",fontFamily:"monospace",padding:"10px",borderRadius:"8px",zIndex:"10000",fontSize:"12px",boxShadow:"0 4px 6px rgba(0,0,0,0.3)",maxHeight:"80vh",overflowY:"auto"})}render(){if(typeof document>"u"){console.log("[DebugOverlay] Virtual Render: Metrics Updated");return}if(!this.container)return;const e=this.signalIntegrity.getEvents(),t=e.filter(n=>n.event_type==="rage_click").length;this.container.innerHTML=`
      <div style="border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 10px; font-weight: bold;">
        PROJECT DOLORES DEBUG
      </div>
      <div>
        <strong>Recent Signals:</strong>
        <ul style="list-style: none; padding: 0; margin-top: 5px;">
          ${e.slice(-5).reverse().map(n=>`
            <li style="margin-bottom: 4px; border-left: 2px solid #00aa00; padding-left: 5px;">
              [${new Date(n.timestamp).toLocaleTimeString()}] ${n.event_type}
            </li>
          `).join("")}
        </ul>
      </div>
      <div style="margin-top: 10px; padding-top: 5px; border-top: 1px solid #333;">
        <strong>Metrics:</strong><br/>
        Rage Clicks: <span style="color: ${t>0?"#ff4444":"#00ff00"}">${t}</span><br/>
        Est. Unique Users: ${this.signalIntegrity.simulateThetaSketch(e.map(n=>n.user_id)).estimate}<br/>
        <strong>Bucket:</strong> <span style="color: #00ffff">${this.mockContext.getBucket()}</span>
      </div>
    `}}class ve{context;si;productId;container=null;constructor(e,t,n="gold_100"){this.context=e,this.si=t,this.productId=n}async render(e=null){if(typeof document>"u"){console.log(`[GoldGate] Virtual Render: Discovered Product ${this.productId}`);return}const t=e||document.body,n=this.context.getBucket(),o=(await this.context.reddit.getProducts()).find(a=>a.id===this.productId);if(!o){console.error(`[GoldGate] Product ${this.productId} not found`);return}const c=n==="treatment"?Math.floor(o.price_gold*.8):o.price_gold;this.container=document.createElement("div"),this.container.id="gold-gate-container",this.applyStyles(),this.container.innerHTML=`
      <div style="background: #1a1a1b; color: #d7dadc; padding: 20px; border-radius: 8px; border: 1px solid #343536; text-align: center; width: 350px;">
        <h3 style="margin-top: 0; color: #ffd700;">Exclusive Offer</h3>
        <p style="font-size: 14px;">Get <strong>${o.name}</strong> to unlock premium features.</p>
        <div style="margin: 20px 0;">
          <span style="font-size: 24px; font-weight: bold; color: ${n==="treatment"?"#44ff44":"#ffffff"}">
            ${c} Gold
          </span>
          ${n==="treatment"?`<br/><small style="text-decoration: line-through; opacity: 0.6;">${o.price_gold} Gold</small>`:""}
        </div>
        <button id="gold-gate-buy-btn" style="background: #ff4500; color: white; border: none; padding: 12px 24px; border-radius: 999px; cursor: pointer; font-weight: bold; width: 100%;">
          Purchase Now
        </button>
        <p style="font-size: 10px; margin-top: 10px; opacity: 0.5;">Experiment Bucket: ${n}</p>
      </div>
    `,t.appendChild(this.container),document.getElementById("gold-gate-buy-btn")?.addEventListener("click",async()=>{this.si.capture("gold_gate_click","user_id",{bucket:n,price:c});const a=await this.context.reddit.pay({productId:this.productId});a.status==="success"?(this.si.capture("gold_gate_purchase_success","user_id",{bucket:n}),alert("Purchase successful!")):(this.si.capture("gold_gate_purchase_failed","user_id",{bucket:n,reason:a.reason}),alert(`Purchase failed: ${a.reason}`))}),this.si.capture("gold_gate_impression","user_id",{bucket:n,price:c})}applyStyles(){this.container&&Object.assign(this.container.style,{position:"fixed",bottom:"100px",right:"20px",zIndex:"9999",fontFamily:"sans-serif"})}}class q{config;container=null;constructor(e){this.config=e}renderData(e,t=0){if(typeof document>"u")return"";let n=`<ul style="list-style: none; padding-left: ${t*15}px;">`;for(const i in e){const o=e[i],c=typeof o=="object"&&o!==null;n+='<li style="margin-bottom: 5px;">',c?(n+=`<div style="font-weight: bold; cursor: pointer;">‚ñ∂ ${i}</div>`,n+=this.renderData(o,t+1)):n+=`
          <div style="display: flex; justify-content: space-between; width: 200px;">
            <span style="opacity: 0.8;">${i}:</span>
            <input type="text" value="${o}" style="width: 80px; background: #333; color: white; border: none;" />
          </div>
        `,n+="</li>"}return n+="</ul>",n}renderCLI(e=this.config,t=""){let n="";const i=Object.entries(e);return i.forEach(([o,c],a)=>{const d=a===i.length-1,h=d?"‚îî‚îÄ‚îÄ ":"‚îú‚îÄ‚îÄ ",m=t+(d?"    ":"‚îÇ   ");typeof c=="object"&&c!==null?(n+=`${t}${h}${o}
`,n+=this.renderCLI(c,m)):n+=`${t}${h}${o}: ${c}
`}),n}}class N{constructor(e){this.width=10,this.height=10,this.context=e}async setPixel(e,t,n){if(e<0||e>=this.width||t<0||t>=this.height)throw new Error("Coordinates out of bounds");const i=`pixel:${e}:${t}`;await this.context.redis.set(i,n),this.context.realtime.send("board_update",{x:e,y:t,color:n}),console.log(`[PixelBoard] Set pixel (${e}, ${t}) to ${n}`)}async clearPixel(e,t){await this.setPixel(e,t,"#ffffff")}async getBoard(){const e=Array(this.height).fill(null).map(()=>Array(this.width).fill("#ffffff"));for(let t=0;t<this.height;t++)for(let n=0;n<this.width;n++){const i=await this.context.redis.get(`pixel:${n}:${t}`);i&&(e[t][n]=i)}return e}}class R{constructor(){}static getInstance(){return R.instance||(R.instance=new R),R.instance}async analyzeResponse(e,t){if(await new Promise(o=>setTimeout(o,800)),t.split(" ").length<5)return null;const n=t.toLowerCase();if(n.includes("color")||n.includes("palette")||n.includes("red")||n.includes("blue"))return"Interesting choice of colors. Did you find the current palette sufficient for your expression?";if(n.includes("grid")||n.includes("size")||n.includes("small")||n.includes("big"))return"How would a different grid size change your strategy?";if(n.includes("click")||n.includes("place")||n.includes("mouse")||n.includes("tap"))return"Did the interaction feel responsive enough during rapid placement?";if(n.includes("feature")||n.includes("add")||n.includes("wish"))return"If we added that feature, what is the first thing you would build with it?";const i=["Can you elaborate a bit more on that?","That's a unique perspective. Why do you feel that way?","How did that impact your overall decision making?"];return i[Math.floor(Math.random()*i.length)]}async generateRageClickIntervention(){await new Promise(t=>setTimeout(t,300));const e=["It seems like you're clicking quite rapidly. Is the interface not responding as you expect?","I noticed some rapid interaction. Are you experiencing any frustration with the pixel placement?","Whoa, those were some fast clicks! Did something unexpected happen with the board?","Is everything working okay? I detected some intense clicking just now."];return e[Math.floor(Math.random()*e.length)]}}const we=Object.freeze(Object.defineProperty({__proto__:null,GeminiModerator:R},Symbol.toStringTag,{value:"Module"}));class Ee{constructor(e){this.questions=[],this.currentIndex=0,this.container=null,this.isOpen=!1,this.moderator=R.getInstance(),this.context=e,this.seedQuestions()}seedQuestions(){this.questions=[{id:"q1",text:"How would you rate your experience placing pixels?",type:"rating",followUpEnabled:!1},{id:"q2",text:"Did you find the 'Buy Premium' option intrusive?",type:"binary",followUpEnabled:!1},{id:"q3",text:"What motivated you to choose the colors you used?",type:"open",followUpEnabled:!0},{id:"q4",text:"How likely are you to recommend this to a friend?",type:"rating",followUpEnabled:!1},{id:"q5",text:"If you could add one feature, what would it be?",type:"open",followUpEnabled:!0},{id:"q6",text:"Do you prefer the current grid size?",type:"binary",followUpEnabled:!1},{id:"q7",text:"Rate the responsiveness of the interface.",type:"rating",followUpEnabled:!1},{id:"q8",text:"Any final thoughts?",type:"open",followUpEnabled:!0}]}getQuestions(){return[...this.questions]}addQuestion(e){this.questions.push(e)}updateQuestion(e,t){const n=this.questions.findIndex(i=>i.id===e);n!==-1&&(this.questions[n]={...this.questions[n],...t})}deleteQuestion(e){this.questions=this.questions.filter(t=>t.id!==e)}start(){this.isOpen||(this.isOpen=!0,this.currentIndex=0,this.renderOverlay(),this.showQuestion())}renderOverlay(){this.container=document.createElement("div"),this.container.id="qualitative-study-overlay",Object.assign(this.container.style,{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",backgroundColor:"rgba(0,0,0,0.85)",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",zIndex:"10000",color:"white"}),document.body.appendChild(this.container)}async showQuestion(){if(!this.container)return;if(this.container.innerHTML="",this.currentIndex>=this.questions.length){this.showCompletion();return}const e=this.questions[this.currentIndex],t=document.createElement("div");Object.assign(t.style,{backgroundColor:"#222",padding:"30px",borderRadius:"12px",maxWidth:"500px",width:"90%",textAlign:"center",border:"1px solid #444"});const n=e.id.startsWith("follow_up"),i=document.createElement("h3");i.innerText=n?"Gemini Follow-up":`Question ${this.currentIndex+1}/${this.questions.length}`,n&&(i.style.color="#4dabf7");const o=document.createElement("p");o.innerText=e.text,o.style.fontSize="1.2em",o.style.margin="20px 0",t.appendChild(i),t.appendChild(o);const c=document.createElement("div");if(e.type==="rating"){const a=document.createElement("div");a.style.fontSize="2em",a.style.cursor="pointer",[1,2,3,4,5].forEach(d=>{const h=document.createElement("span");h.innerText="‚òÖ",h.style.color="#444",h.style.margin="0 5px",h.onclick=()=>{Array.from(a.children).forEach((m,x)=>{m.style.color=x<d?"gold":"#444"}),setTimeout(()=>this.nextQuestion(d.toString()),400)},a.appendChild(h)}),c.appendChild(a)}else if(e.type==="binary")["Yes","No"].forEach(a=>{const d=document.createElement("button");d.innerText=a,Object.assign(d.style,{margin:"10px",padding:"10px 30px",fontSize:"1em",cursor:"pointer",background:"#333",color:"white",border:"1px solid #666",borderRadius:"5px"}),d.onclick=()=>this.nextQuestion(a),c.appendChild(d)});else if(e.type==="open"){const a=document.createElement("textarea");Object.assign(a.style,{width:"100%",height:"100px",background:"#111",color:"white",border:"1px solid #555",padding:"10px",fontSize:"1em",borderRadius:"5px",marginBottom:"15px"}),c.appendChild(a);const d=document.createElement("button");d.innerText="Submit Answer",Object.assign(d.style,{padding:"10px 20px",background:"#d93025",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"}),d.onclick=()=>{a.value.trim().length>0&&this.nextQuestion(a.value)},c.appendChild(d)}t.appendChild(c),this.container.appendChild(t)}async nextQuestion(e){const t=this.questions[this.currentIndex];if(this.context?.realtime&&this.context.realtime.connect().emit("moderator_event",{type:"survey_answer",question:t.text,answer:e,timestamp:Date.now()}),t.type==="open"&&t.followUpEnabled&&!t.id.startsWith("follow_up")){const n=document.createElement("p");n.innerText="Gemini is analyzing your response...",n.style.color="#aaa",n.style.marginTop="20px",this.container?.querySelector("div")?.appendChild(n);const i=await this.moderator.analyzeResponse(t.text,e);if(n.remove(),i){const o={id:`follow_up_${Date.now()}`,text:i,type:"open"};this.questions.splice(this.currentIndex+1,0,o)}}this.currentIndex++,this.showQuestion()}async triggerIntervention(e){if(this.isOpen)return;this.isOpen=!0;const t={id:`intervention_${Date.now()}`,text:e,type:"open"};this.renderOverlay(),this.showInterventionQuestion(t)}showInterventionQuestion(e){if(!this.container)return;this.container.innerHTML="";const t=document.createElement("div");Object.assign(t.style,{backgroundColor:"#222",padding:"30px",borderRadius:"12px",maxWidth:"500px",width:"90%",textAlign:"center",border:"2px solid #d93025"});const n=document.createElement("h3");n.innerText="Gemini Observation",n.style.color="#ff6b6b";const i=document.createElement("p");i.innerText=e.text,i.style.fontSize="1.2em",i.style.margin="20px 0",t.appendChild(n),t.appendChild(i);const o=document.createElement("div"),c=document.createElement("textarea");Object.assign(c.style,{width:"100%",height:"80px",background:"#111",color:"white",border:"1px solid #555",padding:"10px",fontSize:"1em",borderRadius:"5px",marginBottom:"15px"}),o.appendChild(c);const a=document.createElement("button");a.innerText="Send Feedback",Object.assign(a.style,{padding:"10px 20px",background:"#d93025",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"}),a.onclick=()=>{this.container?.remove(),this.container=null,this.isOpen=!1},o.appendChild(a),t.appendChild(o),this.container.appendChild(t)}showCompletion(){this.container&&(this.container.innerHTML=`
            <div style="text-align:center; background:#222; padding:40px; border-radius:12px; max-width:500px; width:90%;">
                <h2 style="color:gold;">Study Complete!</h2>
                <p>Thank you for participating in our qualitative research.</p>
                <div style="font-size:3em; margin:20px;">üéÅ</div>
                <p>You've earned the <strong>Research Contributor</strong> badge.</p>
                <button id="close-study-btn" style="margin-top:20px; padding:10px 20px; font-size:1.1em; cursor:pointer;">Return to Game</button>
            </div>
        `,document.getElementById("close-study-btn")?.addEventListener("click",()=>{this.container?.remove(),this.container=null,this.isOpen=!1}))}}class Ce{constructor(e){this.container=null,this.isOpen=!1,this.study=e}toggle(){this.isOpen?this.close():this.open()}open(){this.isOpen||(this.isOpen=!0,this.render())}close(){this.container&&(this.container.remove(),this.container=null),this.isOpen=!1}render(){this.container=document.createElement("div"),Object.assign(this.container.style,{position:"fixed",top:"10px",right:"10px",bottom:"10px",width:"400px",backgroundColor:"#1a1a1a",border:"1px solid #444",borderRadius:"8px",boxShadow:"-2px 0 10px rgba(0,0,0,0.5)",zIndex:"20000",display:"flex",flexDirection:"column",color:"#eee",fontFamily:"sans-serif"});const e=document.createElement("div");Object.assign(e.style,{padding:"15px",background:"#2d2d2d",borderBottom:"1px solid #444",display:"flex",justifyContent:"space-between",alignItems:"center"}),e.innerHTML="<strong>Moderator Dashboard</strong>";const t=document.createElement("button");t.innerText="‚úï",t.onclick=()=>this.close(),e.appendChild(t),this.container.appendChild(e);const n=document.createElement("div");Object.assign(n.style,{flex:"1",overflowY:"auto",padding:"15px"}),this.renderQuestionList(n),this.container.appendChild(n);const i=document.createElement("div");Object.assign(i.style,{padding:"15px",borderTop:"1px solid #444"});const o=document.createElement("button");o.innerText="+ Add Question",Object.assign(o.style,{width:"100%",padding:"8px",cursor:"pointer",backgroundColor:"#4dabf7",border:"none",borderRadius:"4px",color:"white"}),o.onclick=()=>{const c={id:`manual_${Date.now()}`,text:"New Question",type:"open"};this.study.addQuestion(c),this.renderQuestionList(n)},i.appendChild(o),this.container.appendChild(i),document.body.appendChild(this.container)}renderQuestionList(e){e.innerHTML="",this.study.getQuestions().forEach((n,i)=>{const o=document.createElement("div");Object.assign(o.style,{background:"#333",marginBottom:"10px",padding:"10px",borderRadius:"4px",border:"1px solid #555"});const c=document.createElement("div");c.style.display="flex",c.style.justifyContent="space-between",c.style.marginBottom="5px";const a=document.createElement("span");a.innerText=n.type.toUpperCase(),a.style.fontSize="0.7em",a.style.background="#000",a.style.padding="2px 5px",a.style.borderRadius="3px";const d=document.createElement("button");d.innerText=n.followUpEnabled?"ü§ñ Follow-up: ON":"ü§ñ Follow-up: OFF",d.style.fontSize="0.7em",d.style.marginRight="5px",d.style.background=n.followUpEnabled?"#2f9e44":"#555",d.style.color="white",d.style.border="none",d.style.borderRadius="3px",d.style.cursor="pointer",d.onclick=()=>{this.study.updateQuestion(n.id,{followUpEnabled:!n.followUpEnabled}),this.renderQuestionList(e)};const h=document.createElement("div");h.style.display="flex",h.style.alignItems="center";const m=document.createElement("button");m.innerText="‚úé",m.style.marginRight="5px",m.style.cursor="pointer",m.style.background="#444",m.style.color="white",m.style.border="none",m.style.borderRadius="3px",m.onclick=()=>this.editQuestion(n,o);const x=document.createElement("button");x.innerText="üóë",x.style.cursor="pointer",x.style.background="#444",x.style.color="#ff6b6b",x.style.border="none",x.style.borderRadius="3px",x.onclick=()=>{this.study.deleteQuestion(n.id),this.renderQuestionList(e)},h.appendChild(d),h.appendChild(m),h.appendChild(x),c.appendChild(a),c.appendChild(h);const w=document.createElement("div");w.innerText=`${i+1}. ${n.text}`,o.appendChild(c),o.appendChild(w),e.appendChild(o)})}editQuestion(e,t){t.innerHTML="";const n=document.createElement("input");n.value=e.text,Object.assign(n.style,{width:"100%",padding:"5px",marginBottom:"5px"});const i=document.createElement("select");["open","binary","rating"].forEach(d=>{const h=document.createElement("option");h.value=d,h.text=d,d===e.type&&(h.selected=!0),i.appendChild(h)});const o=document.createElement("label");o.style.display="block",o.style.fontSize="0.8em",o.style.marginTop="10px";const c=document.createElement("input");c.type="checkbox",c.checked=!!e.followUpEnabled,o.appendChild(c),o.appendChild(document.createTextNode(" Allow Gemini Follow-up"));const a=document.createElement("button");a.innerText="Save",Object.assign(a.style,{marginTop:"10px",padding:"5px 15px",background:"#4dabf7",border:"none",borderRadius:"4px",cursor:"pointer"}),a.onclick=()=>{this.study.updateQuestion(e.id,{text:n.value,type:i.value,followUpEnabled:c.checked});const d=t.parentElement;d&&this.renderQuestionList(d)},t.appendChild(n),t.appendChild(i),t.appendChild(o),t.appendChild(a)}}class _e{static async selectRole(){return new Promise(e=>{const t=document.createElement("div");Object.assign(t.style,{position:"fixed",top:"0",left:"0",width:"100%",height:"100%",backgroundColor:"#111",color:"white",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",zIndex:"100000",fontFamily:"sans-serif"});const n=document.createElement("h1");n.innerText="Select Your Role",n.style.marginBottom="40px",t.appendChild(n);const i=(c,a,d,h)=>{const m=document.createElement("div");Object.assign(m.style,{background:"#222",border:"1px solid #444",padding:"20px",margin:"10px",width:"300px",cursor:"pointer",borderRadius:"8px",textAlign:"left",transition:"background 0.2s",display:"flex",alignItems:"center"}),m.onmouseover=()=>m.style.background="#333",m.onmouseout=()=>m.style.background="#222",m.onclick=()=>{t.remove(),e(a)};const x=document.createElement("div");x.innerText=h,x.style.fontSize="2.5em",x.style.marginRight="20px";const w=document.createElement("div"),b=document.createElement("div");b.innerText=c,b.style.fontSize="1.2em",b.style.fontWeight="bold";const v=document.createElement("div");return v.innerText=d,v.style.color="#888",v.style.fontSize="0.9em",v.style.marginTop="5px",w.appendChild(b),w.appendChild(v),m.appendChild(x),m.appendChild(w),m};t.appendChild(i("Study Participant","participant","Play the game and take the survey. (Standard User)","üë§")),t.appendChild(i("Study Designer","designer","Construct and edit the qualitative study questions.","üõ†Ô∏è")),t.appendChild(i("Moderator","moderator","Monitor live activity and study results.","üìä")),document.body.appendChild(t);const o=document.getElementById("status-bar");o&&(o.style.zIndex="0")})}}class ke{constructor(e){this.container=null,this.logs=[],this.listContainer=null,this.stats={pixels:0,surveys:0,rage:0,users:1},this.context=e,this.render(),this.listen()}log(e){const t=new Date().toLocaleTimeString();this.logs.unshift(`[${t}] ${e}`),this.renderLogs()}render(){this.container=document.createElement("div"),Object.assign(this.container.style,{position:"absolute",top:"0",left:"0",width:"100vw",height:"100vh",backgroundColor:"#050505",color:"#00ff00",fontFamily:"monospace",padding:"20px",boxSizing:"border-box",overflow:"hidden",display:"flex",flexDirection:"column",zIndex:"100000"});const e=document.createElement("h2");e.innerText="üìä Live Study Monitor",e.style.borderBottom="1px solid #333",e.style.paddingBottom="10px",e.style.marginBottom="20px",this.container.appendChild(e);const t=document.createElement("div");t.style.display="flex",t.style.gap="20px",t.style.marginBottom="20px";const n=(o,c)=>{const a=document.createElement("div");a.style.background="#111",a.style.padding="15px",a.style.minWidth="150px",a.style.border="1px solid #333";const d=document.createElement("div");d.innerText=o,d.style.color="#888";const h=document.createElement("div");return h.innerText=c,h.style.fontSize="2em",h.id=`stat-${o.replace(" ","-")}`,a.appendChild(d),a.appendChild(h),a};t.appendChild(n("Active Users","1")),t.appendChild(n("Pixels Placed","0")),t.appendChild(n("Survey Answers","0")),t.appendChild(n("Rage Clicks","0")),this.container.appendChild(t);const i=document.createElement("div");i.innerText="> Event Stream",i.style.color="#fff",i.style.marginBottom="10px",this.container.appendChild(i),this.listContainer=document.createElement("div"),Object.assign(this.listContainer.style,{flex:"1",overflowY:"auto",background:"#0a0a0a",border:"1px solid #333",padding:"10px",fontSize:"1.1em"}),this.container.appendChild(this.listContainer),document.body.appendChild(this.container),this.log("Session started. Listening for events...")}listen(){this.context?.realtime&&this.context.realtime.connect().subscribe("moderator_event",e=>{switch(e.type){case"session_start":this.log(`NEW USER connected as ${e.userRole}`),this.updateStat("Active Users",++this.stats.users);break;case"pixel_placed":this.log(`Pixel placed at (${e.x}, ${e.y})`),this.updateStat("Pixels Placed",++this.stats.pixels);break;case"survey_answer":this.log(`Survey result: "${e.question.substring(0,30)}..." ‚Üí "${e.answer}"`),this.updateStat("Survey Answers",++this.stats.surveys);break;case"rage_click":this.log("üö® FRUSTRATION DETECTED: Rage click event received"),this.updateStat("Rage Clicks",++this.stats.rage);break}})}updateStat(e,t){const n=`stat-${e.replace(" ","-")}`,i=document.getElementById(n);i&&(i.innerText=t.toString()),i&&(i.style.color="#fff",setTimeout(()=>i.style.color="#00ff00",500))}renderLogs(){this.listContainer&&(this.listContainer.innerHTML="",this.logs.forEach(e=>{const t=document.createElement("div");t.innerText=e,t.style.padding="5px 0",t.style.borderBottom="1px solid #111",this.listContainer.appendChild(t)}))}}const Se=async()=>{const g=await _e.selectRole();console.log(`Starting in role: ${g}`);const e=document.getElementById("status-bar");(b=>{console.log(b),e&&(e.innerText=b)})("Initializing Context...");const n=new ye({userId:"t2_browser_user",bucketId:"treatment"}),i=new Q;new(await U(async()=>{const{SessionTracker:b}=await Promise.resolve().then(()=>xe);return{SessionTracker:b}},void 0)).SessionTracker(i,"t2_browser_user");let o=!1,c=0,a=n.config.Visuals?.Colors?.primary||"#FF4500";const d=new Ee(n),h=(b,v,k,I,S)=>{const P=g==="participant",L=document.getElementById("config-menu-container");if(L)if(L.style.display="block",L.innerHTML="",P){const u=document.createElement("h3");u.innerText=o?"üé® Study Palette (Premium)":"üé® Study Palette (Limited)",L.appendChild(u);const y=document.createElement("div");Object.assign(y.style,{display:"flex",gap:"10px",flexWrap:"wrap",marginTop:"10px"});const f={...S.config.Visuals?.Colors};(o?Object.entries(f):Object.entries(f).filter(([_])=>["primary","secondary","canvasBackground"].includes(_))).forEach(([_,C])=>{const T=document.createElement("div");Object.assign(T.style,{width:"30px",height:"30px",backgroundColor:C,borderRadius:"50%",cursor:"pointer",border:a===C?"3px solid white":"1px solid #555",boxShadow:a===C?"0 0 10px rgba(255,255,255,0.5)":"none"}),T.title=_,T.onclick=()=>{a=C,h(b,v,k,I,S)},y.appendChild(T)}),L.appendChild(y)}else L.innerHTML="<h3>üïµÔ∏è Designer Menu</h3>"+k.renderData(S.config);P||v.mount();const r=document.getElementById("game-container");if(!r)return;r.style.gridTemplateColumns="repeat(10, 1fr)";const s=async()=>{const u=await b.getBoard();r.innerHTML="",u.forEach((y,f)=>{y.forEach((E,_)=>{const C=document.createElement("div");C.className="pixel",C.style.backgroundColor=E,C.title=`(${_}, ${f})`,C.onclick=async()=>{try{if(E!=="#ffffff"&&E===a)await b.clearPixel(_,f);else{const M=S.config.Visuals?.Animations?.placePixelDuration||300;C.style.transition=`transform ${M}ms`,C.style.transform="scale(0.5)",await b.setPixel(_,f,a),S.realtime.connect().send("moderator_event",{type:"pixel_placed",x:_,y:f,timestamp:Date.now()}),c++,c===3&&l()}const T=Date.now();if(window.lastClickTimes||(window.lastClickTimes=[]),window.lastClickTimes.push(T),window.lastClickTimes=window.lastClickTimes.filter(M=>T-M<1e3),window.lastClickTimes.length>=5){window.lastClickTimes=[];const G=await(await U(async()=>{const{GeminiModerator:H}=await Promise.resolve().then(()=>we);return{GeminiModerator:H}},void 0)).GeminiModerator.getInstance().generateRageClickIntervention();d.triggerIntervention(G),S.realtime.connect().send("moderator_event",{type:"rage_click",timestamp:Date.now()})}setTimeout(()=>C.style.transform="scale(1)",100)}catch(T){console.error(T)}},r.appendChild(C)})})},l=()=>{if(document.getElementById("survey-btn"))return;const u=document.createElement("button");u.id="survey-btn",u.innerText="üìã Take Research Survey",Object.assign(u.style,{display:"block",padding:"10px 20px",backgroundColor:"#009688",color:"white",border:"none",borderRadius:"4px",cursor:"pointer",marginTop:"10px"}),u.onclick=()=>d.start(),document.body.appendChild(u)};if(S.realtime.connect().subscribe("board_update",()=>s()),s(),P&&!document.getElementById("buy-btn")){const u=document.createElement("button");u.id="buy-btn",u.innerText="üíé Buy Study Pass",u.style.padding="10px 20px",u.style.marginTop="20px",u.onclick=async()=>{new ve(S,I,"custom_avatar_rare").render(),setTimeout(()=>{o=!0,u.innerText="‚úÖ Premium Unlocked",u.disabled=!0,h(b,v,k,I,S)},1500)},document.body.appendChild(u)}};if(g==="designer"){const b=new N(n),v=new F(i,n),k=new q(n.config);new Ce(d).open(),h(b,v,k,i,n);return}if(g==="moderator"){const b=document.getElementById("game-container");b&&(b.style.display="none");const v=document.querySelector("h1");v&&(v.style.display="none");const k=document.getElementById("status-bar");k&&(k.style.display="none");const I=document.getElementById("config-menu-container");I&&(I.style.display="none"),new ke(n);return}const m=new N(n),x=new F(i,n),w=new q(n.config);h(m,x,w,i,n)};Se().catch(g=>{console.error(g);const e=document.getElementById("status-bar");e&&(e.innerText=`Error: ${g.message}`,e.style.color="red")});
